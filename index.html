<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACgCAMAAAC8Y9NQAAAAflBMVEUAAAD///+ZzP8Anf8Aov8Amv8AlP8Aqv8Aru8Anv8Amf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8Anf8+S878AAAALHRSTlMAAgMEBQYICQoLDA0ODxITFBUWFxgZGhscHR4fICEiIyQlJicoKSorLC0uLzAyYm98AAADfklEQVR42u2b2ZKiMBSG6Y6ICwiCuyK7oiIu77/S6YI6pS0SuAnTOf9vXpIsS/6T9CStVAsLCwsLCwsLCwsLC5vIdI59f6E9yGofBclKjO8T36Y9x5ovp3W9v6D9L1Hk++Fm62v7X+K680U2qfX+gnSAnX6W6v0FCXp/QTrA82T6pPr67/8LkuM8nU6fA+MvSJDmP9Ppc+A9Vf8XJMn0fDqdPmP9X5CcTOfp9Bmz/oKkkOnV6TNR/xc0S86m06fA7P8LmmM6nz4DZv9f0DyfptOnwGf8Bcm5m6fT58Bl/AXJWZpOnwPn8RckZ0un0+fAefwFyVkt06fA97v6779z/3f0v/P0Of9vSJK5/f7D3P4/p86Xf9m+f9L5/knnf9L5/knnf9L5/knnf9L5/knnf9L5/knnf9L5/knnf/L5fX069/90Wf/H38B1X7R+B8XnE4vPZ7Otz2Zdn82mPptVfTar+mxW9dlmS6U5WyrN2VJpzpZK602ltN5USutNpbTeVErrTaW03lRar7XGfK015mutMV9rjflaY77WGPu7mGv7u5hr+7uYa/u7mGv7u5hr+7uY6zNrrM+ssT6zxvrMGuszS6y9Zom11yyx9poly6+9Zvn/sSXL/48tWf5/bMny/2NLlv8fW7L879iS5X/Hlv0Y2Y+R/RjZj5H9GNmPkf0Y2Y+R/RjZj/FfjP9i/Bfjv8i6XWSV3v9R/m399/Xf139f/3399/Xf139f/3399/Xf13/fvK79fS6V6eey6ee0qWfLpp4Nm3oWbOoZsqknxaaeCJt6Amzqy7Sps6LOijoruqyosqLOiior6qyosqLOitqzYvf82D07ds+O3bNj9+zYPTt2z47ds2P37Ni99V67t9xr95Z77d5yr91b7rV7y712b7nX7i332r1NfS99p/0X+S/yX+S/yH+R/yL/Rf6L/Bf5L/Jf5L/Y0mRLky1NtjTZ0mRLky1NtjTZ0mRLky1NtjTZ0mRLky1NtjSZY5o5ZkYzw8xoZpAZTQwyw8hgMwwMNoPAYDMIDDZZZZNFFllkkUUWWWSRRRZZZJFFFllkkUUWWWSRRRY9iR5Ej6EH0UPoMfQQegy9jV5G76KX0avoXfQqeveS99DL6DX0MnoVvYreRS+iV9Gr6F30InoRvYhe/Vf9Ay7R9U9L6v9/AAAA//8DAIDU9P++nO5VAAAAAElFTkSuQmCC">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>æ±ºç­–åŠ©æ‰‹ Pro</title>
    <style>
        :root { --primary: #FF9500; --bg: #F8F9FA; --card: #FFFFFF; --blue: #007AFF; --red: #FF3B30; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: env(safe-area-inset-top) 15px 20px; box-sizing: border-box; color: #333; -webkit-tap-highlight-color: transparent; }
        .header { text-align: center; padding: 15px 0; position: sticky; top: 0; background: var(--bg); z-index: 100; }
        .back-btn { position: absolute; left: 0; top: 18px; display: none; background: #EEE; border: none; padding: 6px 12px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .menu-item { background: var(--card); border-radius: 24px; padding: 30px 15px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.04); transition: 0.2s; border: 1px solid rgba(0,0,0,0.02); }
        .menu-item:active { transform: scale(0.95); }
        .menu-item .icon { font-size: 45px; margin-bottom: 12px; display: block; }
        .menu-item .label { font-weight: bold; font-size: 16px; }
        .menu-item.hero { grid-column: span 2; display: flex; align-items: center; justify-content: center; gap: 20px; padding: 35px; background: linear-gradient(135deg, #ffffff 0%, #fff5e6 100%); }
        .controls { margin-bottom: 15px; }
        .input-row { display: flex; gap: 8px; margin-bottom: 15px; }
        input { flex: 1; border: 1.5px solid #D1D1D6; border-radius: 12px; padding: 12px; font-size: 15px; outline: none; }
        .add-btn { background: var(--primary); color: white; border: none; padding: 0 15px; border-radius: 12px; font-weight: bold; }
        .tab-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; }
        .tab-item { white-space: nowrap; padding: 8px 16px; background: #E5E5EA; border-radius: 20px; font-size: 13px; cursor: pointer; }
        .tab-item.active { background: var(--primary); color: white; font-weight: bold; }
        .result-container { background: #FFF; border: 2.5px dashed var(--primary); border-radius: 28px; padding: 40px 15px; text-align: center; margin: 15px 0; min-height: 80px; }
        .result-text { font-size: 38px; font-weight: 800; color: #FF4500; }
        .main-roll-btn { background: #1C1C1E; color: white; border: none; width: 100%; padding: 20px; border-radius: 18px; font-size: 20px; font-weight: bold; box-shadow: 0 10px 25px rgba(0,0,0,0.1); cursor: pointer; }
        .action-grid { display: none; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .option-btn { padding: 14px; border-radius: 12px; color: white; font-size: 14px; text-align: center; font-weight: bold; border:none; text-decoration: none; cursor: pointer; }
        .history-box { margin-top: 25px; text-align: left; }
        .history-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag { background: #E5E5EA; padding: 6px 12px; border-radius: 10px; font-size: 13px; }
        .tag.remove::after { content: 'Ã—'; margin-left: 5px; color: #999; }
        .page { display: none; }
        .active-page { display: block; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 999; }
        .map-modal { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-radius: 24px 24px 0 0; padding: 20px; box-sizing: border-box; z-index: 1000; }
        .map-option { padding: 15px; border-bottom: 1px solid #EEE; text-align: center; font-size: 18px; color: var(--blue); font-weight: 500; }
        .admin-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: white; border-radius: 24px; padding: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.3); z-index: 2000; }
        .admin-tag { display: inline-block; padding: 5px 10px; border-radius: 8px; margin: 3px; font-size: 12px; color: white; }
    </style>
</head>
<body>

    <div class="header">
        <button id="backBtn" class="back-btn" onclick="goHome()">â† è¿”å›</button>
        <h2 id="title">æ±ºç­–å°åŠ©æ‰‹</h2>
    </div>

    <div id="homePage" class="page active-page">
        <div class="home-grid">
            <div class="menu-item hero" onclick="goTo('food', 'ğŸ± åƒè²¨ç¥å™¨')">
                <span class="icon">ğŸ±</span><span class="label">ä»Šå¤©åƒä»€éº¼ï¼Ÿ</span>
            </div>
            <div class="menu-item" onclick="goTo('play', 'ğŸ¡ å»å“ªç©å…’')">
                <span class="icon">ğŸ¡</span><span class="label">å»å“ªç©å…’</span>
            </div>
            <div class="menu-item" onclick="goTo('dice', 'ğŸ’¸ èª°è²·å–®')">
                <span class="icon">ğŸ’¸</span><span class="label">èª°è²·å–® / èšæœƒ</span>
            </div>
            <div class="menu-item" onclick="goTo('truth', 'ğŸ’¬ çœŸå¿ƒè©±')">
                <span class="icon">ğŸ’¬</span><span class="label">çœŸå¿ƒè©±</span>
            </div>
            <div class="menu-item" onclick="goTo('dare', 'ğŸ­ å¤§å†’éšª')">
                <span class="icon">ğŸ­</span><span class="label">å¤§å†’éšª</span>
            </div>
        </div>
    </div>

    <div id="toolPage" class="page">
        <div class="controls" id="controlsArea">
            <div class="input-row">
                <input type="text" id="toolInput" placeholder="è‡ªå®šç¾©é …ç›®...">
                <button class="add-btn" onclick="handleInput()">æ–°å¢</button>
            </div>
            <div class="tab-bar" id="tabBar"></div>
        </div>
        <div class="result-container"><div id="resultText" class="result-text">ï¼Ÿ</div></div>
        <button class="main-roll-btn" onclick="runRoll()">é–‹å§‹æŠ½å–</button>
        <div id="actionGrid" class="action-grid">
            <a id="linkM" class="option-btn food-only" style="background:#FFD000;color:#333">ç¾åœ˜</a>
            <a id="linkD" class="option-btn food-only" style="background:#FF6633">é»è©•</a>
            <button class="option-btn play-only" style="background:#007AFF; grid-column: span 2;" onclick="showMapOptions()">æ‰“é–‹åœ°åœ–å°èˆª</button>
            <button class="option-btn" id="shareBtn" style="background:#5856D6; grid-column: span 2;" onclick="shareCurrent()">åˆ†äº«çµæœ</button>
        </div>
        <div class="history-box">
            <div id="historyTitle" style="font-weight: bold; color: #8E8E93;">æœ€è¿‘æŠ½ä¸­</div>
            <div class="history-tags" id="historyTags"></div>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closeModals()"></div>
    <div class="map-modal" id="mapModal">
        <div style="font-weight: bold; margin-bottom: 15px; color:#666; text-align: center;">é¸æ“‡åœ°åœ–æ‡‰ç”¨</div>
        <div class="map-option" onclick="openMap('google')">Google Maps</div>
        <div class="map-option" onclick="openMap('apple')">Apple Maps</div>
        <div class="map-option" onclick="openMap('gaode')">é«˜å¾·åœ°åœ–</div>
        <div class="map-option" onclick="openMap('baidu')">ç™¾åº¦åœ°åœ–</div>
        <div class="map-option" style="color:var(--red); border:none" onclick="closeModals()">å–æ¶ˆ</div>
    </div>

    <div class="admin-modal" id="adminModal">
        <h3 style="margin:0 0 10px 0">ğŸ¤« éš±è—æ§åˆ¶ä¸­å¿ƒ</h3>
        <div class="input-row">
            <input type="text" id="adminInput" placeholder="è¼¸å…¥åå–®ä¸­çš„åå­—">
            <button class="add-btn" style="background:var(--red)" onclick="setAdmin('black')">é»‘</button>
            <button class="add-btn" style="background:var(--blue)" onclick="setAdmin('white')">ç™½</button>
        </div>
        <div id="adminList" style="margin-top:10px; max-height:150px; overflow-y:auto"></div>
        <button class="main-roll-btn" style="margin-top:15px; padding:10px" onclick="closeModals()">é—œé–‰</button>
    </div>

<script>
    let db = {
        food: { custom: JSON.parse(localStorage.getItem('f_custom')) || ["ç«é‹", "å£½å¸"], hot: ["æ¼¢å ¡", "æ‹‰éºµ", "ç‰›æ’"], chinese: ["å°ç± åŒ…", "æ»·è‚‰é£¯"], history: JSON.parse(localStorage.getItem('f_hist')) || [] },
        play: { custom: JSON.parse(localStorage.getItem('p_custom')) || ["çœ‹é›»å½±", "çˆ¬å±±"], indoor: ["å¯†å®¤", "KTV"], outdoor: ["å…¬åœ’", "è€è¡—"], history: JSON.parse(localStorage.getItem('p_hist')) || [] },
        dice: { bill: JSON.parse(localStorage.getItem('party_names')) || ["å¼µä¸‰", "æå››"], random: ["1","2","3","4","5","6"] },
        truth: { list: ["çœŸå¿ƒè©±1", "çœŸå¿ƒè©±2"] },
        dare: { list: ["å¤§å†’éšª1", "å¤§å†’éšª2"] }
    };
    let adminDb = JSON.parse(localStorage.getItem('admin_db')) || { black: [], white: [] };
    let currentPage = '', currentTab = '', lastResult = '';

    function goTo(pageId, title) {
        currentPage = pageId; currentTab = (pageId === 'dice') ? 'bill' : 'custom';
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById('backBtn').style.display = 'block';
        document.getElementById('title').innerText = title;
        document.getElementById('toolPage').classList.add('active-page');
        initTabs(); renderHistory(); resetResult();
    }

    function goHome() {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById('homePage').classList.add('active-page');
        document.getElementById('backBtn').style.display = 'none';
        document.getElementById('title').innerText = 'æ±ºç­–å°åŠ©æ‰‹';
    }

    function initTabs() {
        const bar = document.getElementById('tabBar'); bar.innerHTML = '';
        let tabs = [];
        if (currentPage === 'food') tabs = [['custom','æˆ‘çš„'],['hot','ç†±é–€'],['chinese','ä¸­å¼']];
        else if (currentPage === 'play') tabs = [['custom','æˆ‘çš„'],['indoor','å®¤å…§'],['outdoor','æˆ¶å¤–']];
        else if (currentPage === 'dice') tabs = [['bill','èª°è²·å–®'],['random','éª°å­']];
        tabs.forEach(([k, l]) => {
            const d = document.createElement('div');
            d.className = `tab-item ${currentTab === k ? 'active' : ''}`;
            d.innerText = l; d.onclick = (e) => { currentTab = k; initTabs(); resetResult(); renderHistory(); };
            bar.appendChild(d);
        });
        document.getElementById('controlsArea').style.display = (tabs.length > 0) ? 'block' : 'none';
        document.getElementById('toolInput').placeholder = (currentTab === 'bill') ? "è¼¸å…¥åå­— (ç©ºæ ¼éš”é–‹)" : "è‡ªå®šç¾©é …ç›®...";
    }

    function handleInput() {
        const val = document.getElementById('toolInput').value.trim();
        if(val === '#admin') { document.getElementById('toolInput').value = ''; showAdmin(); return; }
        if(!val) return;
        if (currentPage === 'dice' && currentTab === 'bill') {
            const names = val.split(/\s+/);
            db.dice.bill = [...new Set([...db.dice.bill, ...names])];
            localStorage.setItem('party_names', JSON.stringify(db.dice.bill));
        } else if (db[currentPage].custom) {
            db[currentPage].custom.push(val);
            localStorage.setItem(currentPage.charAt(0)+'_custom', JSON.stringify(db[currentPage].custom));
        }
        document.getElementById('toolInput').value = ''; renderHistory();
    }

    function runRoll() {
        let list = (currentPage === 'truth' || currentPage === 'dare') ? db[currentPage].list : db[currentPage][currentTab];
        if(!list || list.length === 0) return alert("åå–®ç‚ºç©º");

        let weightList = [];
        if (currentPage === 'dice' && currentTab === 'bill') {
            list.forEach(name => {
                if (adminDb.white.includes(name)) return;
                if (adminDb.black.includes(name)) { for(let k=0; k<10; k++) weightList.push(name); }
                else { weightList.push(name); }
            });
            if(weightList.length === 0) weightList = list;
        } else { weightList = list; }

        const resEl = document.getElementById('resultText');
        document.getElementById('actionGrid').style.display = 'none';
        let i = 0;
        const timer = setInterval(() => {
            resEl.innerText = list[Math.floor(Math.random() * list.length)];
            if(i++ > 15) {
                clearInterval(timer);
                lastResult = weightList[Math.floor(Math.random() * weightList.length)];
                resEl.innerText = (currentTab === 'bill' ? "ğŸ’¸ " : "âœ¨ ") + lastResult;
                showSpecialButtons();
                if (currentPage !== 'dice' || currentTab !== 'bill') addHistory(lastResult);
            }
        }, 60);
    }

    function showSpecialButtons() {
        document.getElementById('actionGrid').style.display = 'grid';
        document.querySelectorAll('.food-only').forEach(e => e.style.display = (currentPage==='food'?'block':'none'));
        document.querySelectorAll('.play-only').forEach(e => e.style.display = (currentPage==='play'?'block':'none'));
        if(currentPage === 'food') {
            const q = encodeURIComponent(lastResult);
            document.getElementById('linkM').href = `imeituan://www.meituan.com/s/s?w=${q}`;
            document.getElementById('linkD').href = `dianping://search?keyword=${q}`;
        }
    }

    function openMap(type) {
        const q = encodeURIComponent(lastResult);
        let appUrl = '', webUrl = '';
        switch(type) {
            case 'google': appUrl = `comgooglemaps://?q=${q}`; webUrl = `https://www.google.com/maps/search/${q}`; break;
            case 'apple': appUrl = `http://maps.apple.com/?q=${q}`; webUrl = `http://maps.apple.com/?q=${q}`; break;
            case 'gaode': appUrl = `iosamap://search?sourceApplication=foodapp&keywords=${q}&style=2`; webUrl = `https://uri.amap.com/search?keyword=${q}`; break;
            case 'baidu': appUrl = `baidumap://map/search?query=${q}&src=webapp.food.decision`; webUrl = `https://api.map.baidu.com/geocoder?address=${q}&output=html`; break;
        }
        const startTime = Date.now();
        window.location.href = appUrl;
        setTimeout(() => { if (Date.now() - startTime < 2500) window.location.href = webUrl; }, 2000);
        closeModals();
    }

    function showAdmin() { document.getElementById('adminModal').style.display = 'block'; document.getElementById('overlay').style.display = 'block'; renderAdminList(); }
    function setAdmin(type) {
        const name = document.getElementById('adminInput').value.trim();
        if(!name) return;
        adminDb.black = adminDb.black.filter(n => n !== name); adminDb.white = adminDb.white.filter(n => n !== name);
        adminDb[type].push(name); localStorage.setItem('admin_db', JSON.stringify(adminDb));
        document.getElementById('adminInput').value = ''; renderAdminList();
    }
    function renderAdminList() {
        const box = document.getElementById('adminList');
        let html = '';
        adminDb.black.forEach(n => html += `<span class="admin-tag" style="background:var(--red)" onclick="removeAdmin('black','${n}')">${n} (é»‘)</span>`);
        adminDb.white.forEach(n => html += `<span class="admin-tag" style="background:var(--blue)" onclick="removeAdmin('white','${n}')">${n} (ç™½)</span>`);
        box.innerHTML = html;
    }
    function removeAdmin(type, name) { adminDb[type] = adminDb[type].filter(n => n !== name); localStorage.setItem('admin_db', JSON.stringify(adminDb)); renderAdminList(); }
    function closeModals() { document.getElementById('mapModal').style.display = 'none'; document.getElementById('adminModal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }
    function showMapOptions() { document.getElementById('mapModal').style.display = 'block'; document.getElementById('overlay').style.display = 'block'; }
    function renderHistory() {
        const box = document.getElementById('historyTags');
        if (currentPage === 'dice' && currentTab === 'bill') {
            document.getElementById('historyTitle').innerText = "åƒèˆ‡åå–® (é»æ“Šåˆªé™¤)";
            box.innerHTML = db.dice.bill.map(n => `<span class="tag remove" onclick="removeFromBill('${n}')">${n}</span>`).join('');
        } else {
            document.getElementById('historyTitle').innerText = "æœ€è¿‘æŠ½ä¸­";
            box.innerHTML = (db[currentPage].history || []).map(h => `<span class="tag">${h}</span>`).join('');
        }
    }
    function removeFromBill(n) { db.dice.bill = db.dice.bill.filter(x => x !== n); localStorage.setItem('party_names', JSON.stringify(db.dice.bill)); renderHistory(); }
    function addHistory(item) {
        let key = currentPage.charAt(0) + '_hist';
        db[currentPage].history.unshift(item); if(db[currentPage].history.length > 6) db[currentPage].history.pop();
        localStorage.setItem(key, JSON.stringify(db[currentPage].history)); renderHistory();
    }
    function resetResult() { document.getElementById('resultText').innerText = 'ï¼Ÿ'; document.getElementById('actionGrid').style.display = 'none'; }
    function shareCurrent() {
        let text = `å»ºè­°ï¼š${lastResult}`;
        if(currentTab === 'bill') text = `è²·å–®å¤§å†¤ç¨®æ˜¯ï¼š${lastResult}ï¼`;
        if(navigator.share) navigator.share({ title:'æ±ºç­–çµæœ', text: text, url:window.location.href });
    }
</script>
</body>
</html>
